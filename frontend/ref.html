<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Refrendo - Panel de Control</title>
  <link rel="stylesheet" href="ref.css">
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="LOGOEMP.png" alt="Logo" class="sidebar-logo">
      <h2>Panel de <span>Control</span></h2>
    </div>
    
    <nav class="sidebar-nav">
      <ul>
        <li><a href="dash.html">
          <span class="icon">&#127968;</span> Resumen
        </a></li>
        <li><a href="nuev_emp.html" >
          <span class="icon">&#10133;</span> Nuevo Empeño
        </a></li>
        <li><a href="ref.html" class="active">
          <span class="icon">&#128260;</span> Refrendo
        </a></li>
        <li><a href="desemp.html">
          <span class="icon">&#9989;</span> Desempeño
        </a></li>
        <li><a href="reevaluo.html">
          <span class="icon">&#128220;</span> Reevalúo
        </a></li>
        <li><a href="clientes.html">
          <span class="icon">&#128101;</span> Clientes
        </a></li>
        <li><a href="history.html">
          <span class="icon">&#128214;</span> Historial Empeños
        </a></li>
        <li><a href="remate.html">
          <span class="icon">&#128739;</span> Remate Empeños
        </a></li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <a href="index.html"class="logout-button">
        <span class="icon">&#128682;</span> Cerrar Sesión
      </a>
    </div>
  </aside>

  <div class="main-content">
    
    <header class="main-header">
      <button id="menu-toggle" class="hamburger-button">&#9776;</button>
      <h1>Registrar Refrendo</h1>
      <div class="user-info">
        <span>Bienvenido, <strong>Dueño</strong></span>
      </div>
    </header>

    <main class="content">
      
      <div class="search-bar">
        <input type="text" id="busqueda-input" placeholder="Ingrese celular o INE del cliente...">
        <button type="button" id="btn-buscar" class="search-btn">Buscar Cliente</button>
          <span>&#128269;</span> Buscar Cliente
      </div>
      
      <div id="refrendo-details">
        <h3>
          <span class="icon">&#128100;</span> Datos del Empeño 
          <span class="folio">(Folio: 12345)</span>
        </h3>
        
        <div class="refrendo-details-content">
          <div class="form-grid">
            <div class="input-group">
              <label>Cliente</label>
              <input type="text" id="info-cliente" placeholder="Seleccione un empeño..." readonly>
            </div>
            <div class="input-group">
              <label>Artículo</label>
              <input type="text" id="info-articulo" readonly>
            </div>
          </div>

          <h3 class="subsection-title">
            <span class="icon">&#128176;</span> Detalles del Préstamo
          </h3>
          <div class="form-grid cols-3">
            <div class="input-group">
              <label>Monto Préstamo ($)</label>
              <input type="text" id="info-prestamo" readonly>
            </div>
            <div class="input-group">
              <label>Monto Refrendo (Interés Base) ($)</label>
              <input type="text" id="info-interes" readonly>
            </div>
            <div class="input-group">
              <label>Fecha de Vencimiento</label>
              <input type="date" id="info-vencimiento" readonly>
            </div>
          </div>
        </div>

          <h3 class="subsection-title">
            <span class="icon">&#9881;</span> Acciones y Ajustes de Pago
          </h3>
          <div class="form-grid cols-3">
            <div class="input-group">
              <label for="dias-gracia-extra">Añadir Días de Gracia Extra</label>
              <input type="number" id="dias-gracia-extra" name="dias-gracia-extra" value="2" min="0">
            </div>
            <div class="input-group">
              <label for="abono-refrendo">Abono a Refrendo ($)</label>
              <input type="number" id="abono-refrendo" name="abono-refrendo" step="0.01" placeholder="0.00">
            </div>
            <div class="input-group">
              <label for="abono-capital">Abono a Capital ($)</label>
              <input type="number" id="abono-capital" name="abono-capital" step="0.01" placeholder="0.00">
            </div>
          </div>
          <h3 class="subsection-title">
            <span class="icon">&#128203;</span> Cálculo de Pago (Hoy: 30/10/2025)
          </h3>
          
          <div class="payment-summary">
            <div class="summary-item">
              <span>Monto Refrendo (Base):</span>
              <span id="resumen-base">$0.00</span>
            </div>

            <div class="summary-item info">
              <span>Días de Gracia / Retraso:</span>
              <span id="resumen-dias">0 días</span>
            </div>

            <div class="summary-item penalty">
              <span>Recargos:</span>
              <input type="number" id="input-recargos" value="0.00" step="1.00" class="input-monto-editable">
            </div>

            <div class="summary-item penalty">
              <span>Multa:</span>
              <input type="number" id="input-multa" value="0.00" step="1.00" class="input-monto-editable">
            </div>

            <div class="summary-item-details">
              <span id="resumen-mensaje">(Selecciona un empeño para calcular)</span>
            </div>

            <div class="summary-total">
              <span>TOTAL A PAGAR:</span>
              <span id="resumen-total">$0.00</span>
            </div>
          </div>


          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="window.location.href='dash.html'">Cancelar</button>
            <button type="submit" id="btn-pagar" class="btn btn-primary" disabled>Registrar Pago</button>
          </div>
        </div> 
      </div>

    </main>
  <section class="content-placeholder">
        <h2></h2>
        <p>Resultados de clientes.</p>
      <table class="loan-selection">
          <thead>
            <tr>
              <th>Select</th> <th>Folio</th>
              <th>Artículo</th>
              <th>Vencimiento</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tabla-resultados-body">
            <tr>
              <td colspan="5" style="text-align:center; color: #666;">
                Usa el buscador para encontrar al cliente
              </td>
            </tr>
          </tbody>
      </table>
  </section>
  <div class="overlay" id="overlay"></div>
  <script>
    // Lógica para CERRAR SESIÓN
    const btnLogout = document.querySelector('.logout-button');

    if (btnLogout) {
        btnLogout.addEventListener('click', (e) => {
            e.preventDefault(); // Evita que el enlace navegue solo
            
            // 1. Borramos la llave del navegador
            localStorage.removeItem('token_auto_empeno');
            
            // 2. (Opcional) Avisamos al usuario
            alert('Sesión cerrada correctamente');

            // 3. Redirigimos al Login
            window.location.href = 'login.html';
        });
    }

    // Lógica de PROTECCIÓN (Si no tienes llave, ¡fuera de aquí!)
    const token = localStorage.getItem('token_auto_empeno');
    if (!token) {
        window.location.href = 'login.html';
    }

    // --- 1. LÓGICA DE BÚSQUEDA ---
    const btnBuscar = document.getElementById('btn-buscar');
    const inputBusqueda = document.getElementById('busqueda-input');
    const tbody = document.getElementById('tabla-resultados-body');

    btnBuscar.addEventListener('click', async () => {
      const query = inputBusqueda.value.trim();
      
      if (!query) {
        alert("Por favor escribe un nombre, teléfono o INE.");
        return;
      }

      try {
        // Llamamos al endpoint que acabamos de crear
        const response = await fetch(`/clientes/buscar?q=${query}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const clientes = await response.json();
          tbody.innerHTML = ''; // Limpiar tabla

          if (clientes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No se encontraron clientes.</td></tr>';
            return;
          }

          // Por cada cliente encontrado, mostramos sus empeños
          // NOTA: En el futuro esto debería ser una doble búsqueda, 
          // pero por ahora mostraremos los empeños de los clientes encontrados.
          
          clientes.forEach(cliente => {
            // Si el cliente tiene empeños, los mostramos
            if(cliente.empenos && cliente.empenos.length > 0) {
                cliente.empenos.forEach(empeno => {
                    // Solo mostramos empeños ACTIVOS (Vigente o Vencido)
                    if (empeno.estado === 'Vigente' || empeno.estado === 'Vencido') {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <button class="btn-select" onclick="seleccionarEmpeno(${empeno.id}, '${empeno.fecha_vencimiento}', ${empeno.monto_prestamo})">
                                    Seleccionar
                                </button>
                            </td>
                            <td>${empeno.id}</td>
                            <td>${empeno.marca_modelo} <br><small>(${cliente.nombre} ${cliente.apellidos})</small></td>
                            <td>${empeno.fecha_vencimiento}</td>
                            <td><span class="status status-${empeno.estado.toLowerCase()}">${empeno.estado}</span></td>
                        `;
                        tbody.appendChild(tr);
                      
                        // En la parte donde creamos el 'tr' dentro del loop:
                        const nombreCompleto = `${cliente.nombre} ${cliente.apellidos}`;

                        tr.innerHTML = `
                            <td>
                                <button class="btn-select" 
                                    onclick="seleccionarEmpeno(
                                        ${empeno.id}, 
                                        '${empeno.fecha_vencimiento}', 
                                        ${empeno.monto_prestamo}, 
                                        '${nombreCompleto}', 
                                        '${empeno.marca_modelo}'
                                    )">
                                    Seleccionar
                                </button>
                            </td>
                            <td>${empeno.id}</td>
                            <td>${empeno.marca_modelo} <br><small>(${nombreCompleto})</small></td>
                            <td>${empeno.fecha_vencimiento}</td>
                            <td><span class="status status-${empeno.estado.toLowerCase()}">${empeno.estado}</span></td>
                        `;
                    
                      }
                });
            }
          });
          
          if (tbody.innerHTML === '') {
              tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">El cliente existe pero no tiene empeños activos.</td></tr>';
          }

        } else {
          alert("Error al buscar cliente.");
        }
      } catch (error) {
        console.error(error);
        alert("Error de conexión.");
      }
    });

    // --- 2. LÓGICA DE SELECCIÓN (Placeholder) ---
   
   // Variables globales para saber qué estamos pagando
  let empenoSeleccionadoId = null;
  let interesBaseGlobal = 0; // Para recordar el interés original

  // 1. FUNCIÓN DE SELECCIÓN (Actualizada)
  function seleccionarEmpeno(id, fechaVencimientoStr, montoPrestamo, nombreCliente, nombreArticulo) {
      empenoSeleccionadoId = id;

      // Llenar datos informativos
      document.getElementById('info-cliente').value = nombreCliente;
      document.getElementById('info-articulo').value = nombreArticulo;
      document.getElementById('info-prestamo').value = `$${montoPrestamo.toFixed(2)}`;
      document.getElementById('info-vencimiento').value = fechaVencimientoStr;

      // Calcular Interés Base (10%)
      interesBaseGlobal = montoPrestamo * 0.10;
      document.getElementById('info-interes').value = `$${interesBaseGlobal.toFixed(2)}`;
      document.getElementById('resumen-base').innerText = `$${interesBaseGlobal.toFixed(2)}`;

      // Calcular Días de Retraso (Solo informativo)
      const hoy = new Date();
      const fechaVenc = new Date(fechaVencimientoStr + 'T00:00:00');
      const diffTime = hoy - fechaVenc;
      const diasRetraso = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      // Resetear inputs de multas a 0 o sugerir valor
      const inputRecargos = document.getElementById('input-recargos');
      const inputMulta = document.getElementById('input-multa');
      
      // Lógica opcional: Sugerir multa si hay retraso (puedes borrar esto si quieres que empiece en 0)
      if (diasRetraso > 0) {
          document.getElementById('resumen-dias').innerText = `${diasRetraso} días de retraso`;
          document.getElementById('resumen-dias').style.color = 'red';
          inputMulta.value = (diasRetraso * 10).toFixed(2); // Sugerir $10 por día
      } else {
          document.getElementById('resumen-dias').innerText = "Al día";
          document.getElementById('resumen-dias').style.color = 'green';
          inputMulta.value = "0.00";
      }
      inputRecargos.value = "0.00";

      document.getElementById('resumen-mensaje').innerText = `Folio ${id} seleccionado.`;

      // Habilitar botón y calcular total inicial
      document.getElementById('btn-pagar').disabled = false;
      recalcularTotal(); 
  }

  // 2. NUEVA FUNCIÓN: RECALCULAR TOTAL AL ESCRIBIR
  function recalcularTotal() {
      const valRecargos = parseFloat(document.getElementById('input-recargos').value) || 0;
      const valMulta = parseFloat(document.getElementById('input-multa').value) || 0;
      
      const granTotal = interesBaseGlobal + valRecargos + valMulta;

      document.getElementById('resumen-total').innerText = `$${granTotal.toFixed(2)}`;
      
      const btnPagar = document.getElementById('btn-pagar');
      btnPagar.innerText = `Cobrar $${granTotal.toFixed(2)}`;
  }

  // 3. LISTENERS PARA QUE SE ACTUALICE AL ESCRIBIR
  document.getElementById('input-recargos').addEventListener('input', recalcularTotal);
  document.getElementById('input-multa').addEventListener('input', recalcularTotal);

  // 4. ACTUALIZAR EL BOTÓN DE PAGAR (Para enviar los datos reales)
  const btnPagar = document.getElementById('btn-pagar');
  btnPagar.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!empenoSeleccionadoId) return;

      // Obtenemos los valores finales que escribió el usuario
      const totalPagar = parseFloat(document.getElementById('resumen-total').innerText.replace('$',''));
      
      if(!confirm(`¿Cobrar un total de $${totalPagar.toFixed(2)}?`)) return;

      try {
          // Nota: Aquí enviamos un body vacío porque en el paso anterior tu backend calculaba solo.
          // Para que el backend guarde la multa exacta, habría que actualizar main.py,
          // pero por ahora el frontend ya te deja cobrar visualmente.
          const response = await fetch(`/empenos/${empenoSeleccionadoId}/refrendo`, {
              method: 'POST',
              headers: { 
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({}) 
          });

          if (response.ok) {
              alert(`✅ Pago registrado exitosamente.`);
              window.location.reload();
          } else {
              alert("Error al registrar el pago.");
          }
      } catch (error) {
          console.error(error);
          alert("Error de conexión");
      }
  });
  </script>

  <style>
      /* Un poco de estilo para el botón de seleccionar */
      .btn-select {
          background-color: #2a5a8a;
          color: white;
          border: none;
          padding: 5px 10px;
          cursor: pointer;
          border-radius: 4px;
      }
      .btn-select:hover {
          background-color: #113b64;
      }
  </style>
</body>

</html>