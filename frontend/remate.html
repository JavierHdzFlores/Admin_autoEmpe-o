<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remate de Empe√±os - Panel de Control</title>
  <link rel="stylesheet" href="ref.css"> 
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="LOGOEMP.png" alt="Logo" class="sidebar-logo">
      <h2>Panel de <span>Control</span></h2>
    </div>
    
    <nav class="sidebar-nav">
      <ul>
        <li><a href="dash.html">
          <span class="icon">&#127968;</span> Resumen
        </a></li>
        <li><a href="nuev_emp.html" >
          <span class="icon">&#10133;</span> Nuevo Empe√±o
        </a></li>
        <li><a href="ref.html">
          <span class="icon">&#128260;</span> Refrendo
        </a></li>
        <li><a href="desemp.html">
          <span class="icon">&#9989;</span> Desempe√±o
        </a></li>
        <li><a href="reevaluo.html" >
          <span class="icon">&#128220;</span> Reeval√∫o
        </a></li>
        <li><a href="clientes.html">
          <span class="icon">&#128101;</span> Clientes
        </a></li>
        <li><a href="history.html">
          <span class="icon">&#128214;</span> Historial Empe√±os
        </a></li>
        <li><a href="remate.html"class="active">
          <span class="icon">&#128739;</span> Remate Empe√±os
        </a></li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <a href="index.html" class="logout-button">
        <span class="icon">&#128682;</span> Cerrar Sesi√≥n
      </a>
    </div>
  </aside>

  <div class="main-content">
    
    <header class="main-header">
      <button id="menu-toggle" class="hamburger-button">&#9776;</button>
      <h1>Art√≠culos en Remate</h1>
      <div class="user-info">
        <span>Bienvenido, <strong>Due√±o</strong></span>
      </div>
    </header>

    <main class="content">
      <div class="search-bar">
        <input type="text" id="busqueda-remate" placeholder="Buscar art√≠culo en venta...">
        <button type="button" id="btn-buscar-remate" class="search-btn">Buscar</button>
      </div>

      <div class="history-table-container">
        <table>
          <thead>
            <tr>
              <th>Folio</th>
              <th>Art√≠culo</th>
              <th>Precio en venta</th> 
              <th>Precio adquirido</th>
              <th>Fecha Ingreso</th>
              <th>Estado</th>
              <th>Acci√≥n</th> </tr>
          </thead>
          <tbody id="tabla-remates-body">
            </tbody>
        </table>
      </div>
      </div>

    </main>
  </div>

  <div class="overlay" id="overlay"></div>
  <script>
    const token = localStorage.getItem('token_auto_empeno');
    if (!token) window.location.href = 'login.html';

    let inventarioRemates = [];

    // 1. CARGAR Y FILTRAR
    document.addEventListener('DOMContentLoaded', async () => {
      const tbody = document.getElementById('tabla-remates-body');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Cargando inventario...</td></tr>';

      try {
        const res = await fetch('/empenos/todos', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.ok) {
          const todos = await res.json();
          
          // --- FILTRO MAESTRO ---
          // Solo queremos ver lo que est√° 'Rematado' (En Venta) o 'Vendido'
          inventarioRemates = todos.filter(item => 
              item.estado === 'Rematado' || item.estado === 'Vendido'
          );

          renderizarTabla(inventarioRemates);
        }
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Error de conexi√≥n</td></tr>';
      }
    });

    // 2. DIBUJAR TABLA
    function renderizarTabla(lista) {
      const tbody = document.getElementById('tabla-remates-body');
      tbody.innerHTML = '';

      if (lista.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No hay art√≠culos en remate o vendidos.</td></tr>';
        return;
      }

      lista.forEach(item => {
        const tr = document.createElement('tr');
        
        // L√≥gica visual: Si dice "Rematado" en BD, mostramos "En Venta" en pantalla
        let etiquetaEstado = '';
        let botonAccion = '';
        let precioSugerido = item.monto_prestamo * 1.5; // Ejemplo: Se vende al 150% del pr√©stamo

        if (item.estado === 'Rematado') {
            etiquetaEstado = '<span class="status status-rematado">En Venta</span>'; // Usamos clase visual
            // Bot√≥n para vender
            botonAccion = `
              <button class="btn-vender" onclick="venderArticulo(${item.id}, '${item.marca_modelo}', ${precioSugerido})">
                  üí≤ Vender
              </button>`;
        } else if (item.estado === 'Vendido') {
            etiquetaEstado = '<span class="status status-vendido">Vendido</span>';
            botonAccion = '<span style="color:grey; font-size:0.8em;">Venta Finalizada</span>';
        }

        tr.innerHTML = `
          <td>${item.id}</td>
          <td style="font-weight:bold;">${item.marca_modelo}</td>
          <td>$${precioSugerido.toFixed(2)}</td>
          <td>${item.fecha_vencimiento}</td> <td>${etiquetaEstado}</td>
          <td>${botonAccion}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 3. BUSCADOR
    const inputBus = document.getElementById('busqueda-remate');
    inputBus.addEventListener('input', (e) => {
        const texto = e.target.value.toLowerCase();
        const filtrados = inventarioRemates.filter(item => 
            item.marca_modelo.toLowerCase().includes(texto) || 
            item.id.toString().includes(texto)
        );
        renderizarTabla(filtrados);
    });

    // 4. FUNCI√ìN VENDER
    window.venderArticulo = async function(id, nombre, precioSugerido) {
        const precioReal = prompt(`Vender "${nombre}".\nPrecio Sugerido: $${precioSugerido}\n\nIngresa el precio final de venta:`, precioSugerido);
        
        if (precioReal === null) return; // Cancelado
        
        try {
            const res = await fetch(`/empenos/${id}/venta`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({ precio_venta: parseFloat(precioReal) })
            });

            if (res.ok) {
                alert("‚úÖ ¬°Art√≠culo vendido y dinero ingresado a caja!");
                window.location.reload();
            } else {
                alert("Error al registrar venta");
            }
        } catch (e) {
            alert("Error de conexi√≥n");
        }
    }
  </script>

  <style>
      .status-rematado { background-color: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
      .status-vendido { background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
      
      .btn-vender {
          background-color: #28a745;
          color: white;
          border: none;
          padding: 5px 10px;
          border-radius: 4px;
          cursor: pointer;
      }
      .btn-vender:hover { background-color: #218838; }
  </style>
</body>
</html>