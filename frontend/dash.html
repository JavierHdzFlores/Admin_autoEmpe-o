<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Control - Auto Empeño Luna</title>
  <link rel="stylesheet" href="dash.css">
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="LOGOEMP.png" alt="Logo" class="sidebar-logo">
      <h2>Panel de <span>Control</span></h2>
    </div>
    
    <nav class="sidebar-nav">
      <ul>
        <li><a href="dash.html" class="active">
          <span class="icon">&#127968;</span> Resumen 
        </a></li>
        <li><a href="nuev_emp.html">
          <span class="icon">&#10133;</span> Nuevo Empeño
        </a></li>
        <li><a href="ref.html">
          <span class="icon">&#128260;</span> Refrendo
        </a></li>
        <li><a href="desemp.html">
          <span class="icon">&#9989;</span> Desempeño
        </a></li>
        <li><a href="reevaluo.html">
          <span class="icon">&#128220;</span> Revalúo
        </a></li>
        <li><a href="clientes.html">
          <span class="icon">&#128101;</span> Clientes
        </a></li>
        <li><a href="history.html">
          <span class="icon">&#128214;</span> Historial Empeños
        </a></li>
        <li><a href="remate.html">
          <span class="icon">&#128739;</span> Remate Empeños
        </a></li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <a href="index.html" class="logout-button">
        <span class="icon">&#128682;</span> Cerrar Sesión
      </a>
    </div>
  </aside>

  <div class="main-content">
    
    <header class="main-header">
      <button id="menu-toggle" class="hamburger-button">&#9776;</button>
      <h1>Historial de ultimas acciones</h1>
      <div class="user-info">
        <span>Bienvenido, <strong>Dueño</strong></span>
      </div>
    </header>

    <main class="content">
      
      <section class="stats-cards">
        <div class="card">
          <h3>Total de Empeños</h3>
          <p class="stat-number" id="stat-total">Cargando...</p>
        </div>
        <div class="card">
          <h3>Total de Empeños Activos</h3>
          <p class="stat-number" id="stat-activos">Cargando...</p>
        </div>
        <div class="card">
          <h3>Articulos desmpeñados </h3>
          <p class="stat-number" id="stat-desempenados">Cargando...</p>
        </div>
        <div class="card">
          <h3>Artículos en Remate</h3>
          <p class="stat-number" id="stat-perdidos">Cargando...</p>
        </div>
      </section>

      <section class="content-placeholder">
        <h2>Acciones Rápidas</h2>
        <p>Clientes recientes.</p>
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Acción</th>
              <th>Artículo</th>
              <th>Monto</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="tabla-acciones-body">
            </tbody>
        </table>
      </section>

    </main>
  </div>

  <div class="overlay" id="overlay"></div>

  <script>
    // Lógica para CERRAR SESIÓN
    const btnLogout = document.querySelector('.logout-button');

    if (btnLogout) {
        btnLogout.addEventListener('click', (e) => {
            e.preventDefault(); // Evita que el enlace navegue solo
            
            // 1. Borramos la llave del navegador
            localStorage.removeItem('token_auto_empeno');
            
            // 2. (Opcional) Avisamos al usuario
            alert('Sesión cerrada correctamente');

            // 3. Redirigimos al Login
            window.location.href = '/';
        });
    }

    // Lógica de PROTECCIÓN (Si no tienes llave, ¡fuera de aquí!)
    const token = localStorage.getItem('token_auto_empeno');
    if (!token) {
        window.location.href = '/';
    }
    // Función para cargar datos del Dashboard
    async function cargarDashboard() {
        const token = localStorage.getItem('token_auto_empeno');
        console.log("Token recuperado:", token);

        try {
            // 1. Cargar contadores (Tarjetas)
            // ... dentro de cargarDashboard ...

            // 2. Cargar Tabla de Acciones Rápidas
            const resTabla = await fetch('/dashboard/tabla', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (resTabla.ok) {
                const filas = await resTabla.json();
                const tbody = document.getElementById('tabla-acciones-body');
                tbody.innerHTML = ''; 

                if (filas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Sin movimientos recientes</td></tr>';
                } else {
                    filas.forEach(fila => {
                        const tr = document.createElement('tr');
                        
                        // LÓGICA DE COLORES SEGÚN ACCIÓN
                        let badgeClass = 'status-vigente'; // Por defecto
                        let signo = '+'; // Dinero entra
                        
                        if (fila.accion === 'Nuevo Empeño') {
                            badgeClass = 'status-nuevo'; // Azul
                            signo = '-'; // Dinero sale (prestamos)
                        } else if (fila.accion === 'Desempeño' || fila.accion === 'Venta Remate') {
                            badgeClass = 'status-desempeno'; // Verde (Liquidación)
                        } else if (fila.accion === 'Refrendo') {
                            badgeClass = 'status-refrendo'; // Naranja
                        }

                        // Formato de moneda
                        const montoFmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(fila.monto);

                        tr.innerHTML = `
                            <td><span style="font-weight:bold; color:#555;">${fila.cliente}</span></td>
                            <td><span class="status ${badgeClass}">${fila.accion}</span></td>
                            <td>${fila.articulo}</td>
                            <td style="font-weight:bold;">${signo} ${montoFmt}</td>
                            <td>${fila.fecha}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }
        } catch (error) {
            console.error('Error cargando dashboard:', error);
        }
          // --- 2. FUNCIÓN MATEMÁTICA DE RESUMEN (NUEVO) ---
    function calcularEstadisticas(datos) {
        // 1. Total Histórico
        document.getElementById('stat-total').innerText = datos.length;

        // 2. Activos (Sumamos Vigentes y Vencidos, pues aun tienes la prenda)
        const activos = datos.filter(item => 
            item.estado === 'Vigente' || item.estado === 'Vencido'
        ).length;
        document.getElementById('stat-activos').innerText = activos;

        // 3. Desempeñados (Ya pagaron y se fueron)
        const desempenados = datos.filter(item => item.estado === 'Desempeñado').length;
        document.getElementById('stat-desempenados').innerText = desempenados;

        // 4. Perdidos (Rematados / Vendidos)
        const perdidos = datos.filter(item => 
            item.estado === 'Rematado' || item.estado === 'Vendido'
        ).length;
        document.getElementById('stat-perdidos').innerText = perdidos;
    }
    }
    // Ejecutar cuando cargue la página
    document.addEventListener('DOMContentLoaded', cargarDashboard);
  </script>
</body>
</html>