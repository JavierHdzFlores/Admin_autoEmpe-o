<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clientes - Panel de Control</title>
  <link rel="stylesheet" href="ref.css"> 
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="LOGOEMP.png" alt="Logo" class="sidebar-logo">
      <h2>Panel de <span>Control</span></h2>
    </div>
    
    <nav class="sidebar-nav">
      <ul>
        <li><a href="dash.html">
          <span class="icon">&#127968;</span> Dashboard
        </a></li>
        <li><a href="nuev_emp.html" >
          <span class="icon">&#10133;</span> Nuevo Empeño
        </a></li>
        <li><a href="ref.html">
          <span class="icon">&#128260;</span> Refrendo
        </a></li>
        <li><a href="desemp.html">
          <span class="icon">&#9989;</span> Desempeño
        </a></li>
        <li><a href="reevaluo.html" >
          <span class="icon">&#128220;</span> Reevalúo
        </a></li>
        <li><a href="clientes.html"class="active">
          <span class="icon">&#128101;</span> Clientes
        </a></li>
        <li><a href="history.html">
          <span class="icon">&#128214;</span> Historial Empeños
        </a></li>
        <li><a href="remate.html">
          <span class="icon">&#128739;</span> Remate Empeños
        </a></li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <a href="login.html" class="logout-button">
        <span class="icon">&#128682;</span> Cerrar Sesión
      </a>
    </div>
  </aside>

  <div class="main-content">
    
    <header class="main-header">
      <button id="menu-toggle" class="hamburger-button">&#9776;</button>
      <h1>Administración de Clientes</h1>
      <div class="user-info">
        <span>Bienvenido, <strong>Dueño</strong></span>
      </div>
    </header>

    <main class="content">
      
      <div class="search-section">
        <h3><span class="icon">&#128269;</span> Buscar Cliente</h3>
        
        <div class="search-form-content">
          <form id="search-form" class="search-form">
            <div class="input-group">
              <label for="search-query">Buscar por Celular, Nombre o INE</label>
              <input type="text" id="search-query" name="search-query" placeholder="Escribe tu término de búsqueda..." required>
            </div>
            <button type="submit" class="btn btn-primary">
              <span class="icon">&#128269;</span> Buscar
            </button>
          </form>
        </div>
      </div>

      <div id="client-details">
        <h3>
          <span class="icon">&#128100;</span> Datos del Cliente
        </h3>
        
        <div class="client-details-content">
          <div class="form-grid">
            <div class="input-group full-width">
              <label>Nombre Completo</label>
              <input type="text" value="Maria Guadalupe López García" readonly>
            </div>
            <div class="input-group">
              <label>Teléfono / Celular</label>
              <input type="text" value="953 111 2233" readonly>
            </div>
            <div class="input-group">
              <label>Núm. de INE</label>
              <input type="text" value="1234567890123" readonly>
            </div>
            <div class="input-group full-width">
              <label>Dirección</label>
              <input type="text" value="Calle Falsa 123, Col. Centro, Huajuapan de León" readonly>
            </div>
          </div>

          <h3 class="subsection-title">
            <span class="icon">&#128202;</span> Resumen de Actividad
          </h3>
          <div class="client-stats-grid">
            <div class="card">
              <h3>Empeños Totales</h3>
              <span class="stat-number">5</span>
            </div>
            <div class="card">
              <h3>Empeños Activos</h3>
              <span class="stat-number">2</span>
            </div>
            <div class="card">
              <h3>Desempeñados</h3>
              <span class="stat-number">2</span>
            </div>
            <div class="card">
              <h3>Empeños Perdidos</h3>
              <span class="stat-number">1</span>
            </div>
            </div>

          <h3 class="subsection-title">
            <span class="icon">&#128214;</span> Historial de Empeños
          </h3>
          
          <div class="history-table-container">
            <table>
              <thead>
                <tr>
                  <th>Folio</th>
                  <th>Artículo</th>
                  <th>Monto Préstamo</th>
                  <th>Fecha Empeño</th>
                  <th>Fecha Venc.</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>12345</td>
                  <td>Anillo de Oro 14k</td>
                  <td>$5,000.00</td>
                  <td>23/09/2025</td>
                  <td>23/10/2025</td>
                  <td><span class="status status-vigente">Vigente</span></td>
                </tr>
                <tr>
                  <td>12001</td>
                  <td>Laptop HP Pavilion</td>
                  <td>$4,000.00</td>
                  <td>15/09/2025</td>
                  <td>15/10/2025</td>
                  <td><span class="status status-vencido">Vencido</span></td>
                </tr>
                <tr>
                  <td>11500</td>
                  <td>Celular Samsung A51</td>
                  <td>$2,500.00</td>
                  <td>01/08/2025</td>
                  <td>01/09/2025</td>
                  <td><span class="status status-desempenado">Desempeñado</span></td>
                </tr>
                <tr>
                  <td>10100</td>
                  <td>Esmeriladora Makita</td>
                  <td>$800.00</td>
                  <td>10/05/2025</td>
                  <td>10/06/2025</td>
                  <td><span class="status status-rematado">Rematado</span></td>
                </tr>
                <tr>
                  <td>10050</td>
                  <td>Cadena de Plata</td>
                  <td>$1,200.00</td>
                  <td>01/05/2025</td>
                  <td>01/06/2025</td>
                  <td><span class="status status-desempenado">Desempeñado</span></td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>

    </main>
  </div>

  <div class="overlay" id="overlay"></div>
  <script>
    // --- 1. SEGURIDAD: Verificar si hay token ---
    const token = localStorage.getItem('token_auto_empeno');
    if (!token) {
      window.location.href = 'login.html';
    }

    // --- 2. LÓGICA DE CERRAR SESIÓN (LOGOUT) ---
    const btnLogout = document.querySelector('.logout-button');
    
    if (btnLogout) {
        btnLogout.addEventListener('click', (e) => {
            e.preventDefault(); // ¡Importante! Evita que el enlace actúe normal
            
            // Borramos la llave
            localStorage.removeItem('token_auto_empeno');
            
            // Redirigimos al login
            window.location.href = 'login.html';
        });
    }

    // --- 3. CARGAR TABLA DE CLIENTES/EMPEÑOS ---
    async function cargarTabla() {
      try {
        const response = await fetch('http://localhost:8000/empenos/todos', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const empenos = await response.json();
          
          // Buscamos el cuerpo de la tabla
          // ¡Asegúrate de ponerle id="tabla-clientes-body" a tu <tbody> en el HTML!
          const tbody = document.querySelector('tbody'); 
          tbody.innerHTML = ''; // Limpiamos los datos de ejemplo

          if (empenos.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay registros aún.</td></tr>';
              return;
          }

          // Dibujamos cada fila con datos reales
          empenos.forEach(empeno => {
            const fila = document.createElement('tr');
            
            // Nota: empeno.fecha_vencimiento viene como YYYY-MM-DD
            fila.innerHTML = `
              <td>${empeno.cliente_id}</td> 
              <td>${empeno.id}</td>
              <td>${empeno.marca_modelo}</td>
              <td>$${empeno.monto_prestamo}</td>
              <td>${empeno.fecha_empeno}</td>
              <td>${empeno.fecha_vencimiento}</td>
              <td><span class="status status-${empeno.estado.toLowerCase()}">${empeno.estado}</span></td>
            `;
            tbody.appendChild(fila);
          });

        } else {
          console.error("Error del servidor:", response.status);
          if(response.status === 401) {
              localStorage.removeItem('token_auto_empeno');
              window.location.href = 'login.html';
          }
        }
      } catch (error) {
        console.error("Error de conexión:", error);
      }
    }

    // Ejecutar al cargar la página
    document.addEventListener('DOMContentLoaded', cargarTabla);
  </script>
</body>
</html>