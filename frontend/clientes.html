<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clientes - Panel de Control</title>
  <link rel="stylesheet" href="ref.css"> 
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="LOGOEMP.png" alt="Logo" class="sidebar-logo">
      <h2>Panel de <span>Control</span></h2>
    </div>
    
    <nav class="sidebar-nav">
      <ul>
        <li><a href="dash.html">
          <span class="icon">&#127968;</span> Resumen
        </a></li>
        <li><a href="nuev_emp.html" >
          <span class="icon">&#10133;</span> Nuevo Empeño
        </a></li>
        <li><a href="ref.html">
          <span class="icon">&#128260;</span> Refrendo
        </a></li>
        <li><a href="desemp.html">
          <span class="icon">&#9989;</span> Desempeño
        </a></li>
        <li><a href="reevaluo.html" >
          <span class="icon">&#128220;</span> Reevalúo
        </a></li>
        <li><a href="clientes.html"class="active">
          <span class="icon">&#128101;</span> Clientes
        </a></li>
        <li><a href="history.html">
          <span class="icon">&#128214;</span> Historial Empeños
        </a></li>
        <li><a href="remate.html">
          <span class="icon">&#128739;</span> Remate Empeños
        </a></li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <a href="login.html" class="logout-button">
        <span class="icon">&#128682;</span> Cerrar Sesión
      </a>
    </div>
  </aside>

  <div class="main-content">
    
    <header class="main-header">
      <button id="menu-toggle" class="hamburger-button">&#9776;</button>
      <h1>Administración de Clientes</h1>
      <div class="user-info">
        <span>Bienvenido, <strong>Dueño</strong></span>
      </div>
    </header>

    <main class="content">
      
      <div class="filters">
        <div class="filter-group">
          <label>Buscar Cliente / Artículo:</label>
          <button type="button" id="btn-buscar" class="search-btn">Buscar</button>
          <input type="text" id="filtro-texto" placeholder="Nombre, Folio o Artículo...">
        </div>
        
        <div class="filter-group">
          <label>Estado:</label>
          <select id="filtro-estado">
            <option value="">Todos</option>
            <option value="Vigente">Vigente</option>
            <option value="Vencido">Vencido</option>
            <option value="Desempeñado">Desempeñado</option>
            <option value="Rematado">Rematado</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Desde:</label>
          <input type="date" id="filtro-fecha-inicio">
        </div>
        
        <div class="filter-group">
          <label>Hasta:</label>
          <input type="date" id="filtro-fecha-fin">
        </div>

        <button class="btn-secondary" onclick="limpiarFiltros()" style="height: 40px; align-self: flex-end;">Limpiar</button>
        
        <div class="search-bar">
                
      </div>
      </div>
      
      <div id="client-details">
        <h3>
          <span class="icon">&#128100;</span> Clientes Recientes
        </h3>
        <table>
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Folio</th>
            <th>Artículo</th>
            <th>Monto</th>
            <th>Fecha Empeño</th>
            <th>Vencimiento</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="tabla-clientes-body">
          </tbody>
      </table>
        
        <h3 class="subsection-title">
          <span class="icon">&#128202;</span> Resumen de Actividad
        </h3>

        <div class="client-stats-grid">
          <div class="card">
            <h3>Empeños Totales</h3>
            <span class="stat-number" id="stat-total">0</span>
          </div>
          
          <div class="card">
            <h3>Empeños Activos</h3>
            <span class="stat-number" id="stat-activos">0</span>
          </div>
          
          <div class="card">
            <h3>Desempeñados</h3>
            <span class="stat-number" id="stat-desempenados">0</span>
          </div>
          
          <div class="card">
            <h3>Empeños Perdidos</h3>
            <span class="stat-number" id="stat-perdidos">0</span>
          </div>
        </div>
      </table>
    </div>

        </div>
      </div>

    </main>
  </div>

  <div class="overlay" id="overlay"></div>
 <script>
    const token = localStorage.getItem('token_auto_empeno');
    if (!token) window.location.href = 'login.html';

    let todosLosEmpenos = [];

    // --- 1. CARGAR DATOS ---
    async function cargarTabla() {
      const tbody = document.getElementById('tabla-clientes-body');
      // tbody.innerHTML = '... cargando ...'; (Opcional)

      try {
        const response = await fetch('/empenos/todos', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          todosLosEmpenos = await response.json();
          
          // A. Dibujamos la tabla
          renderizarTabla(todosLosEmpenos);
          
          // B. Calculamos los contadores de arriba (¡NUEVO!)
          calcularEstadisticas(todosLosEmpenos);

        } else {
          console.error("Error cargando datos");
          if(response.status === 401) window.location.href = 'login.html';
        }
      } catch (error) {
        console.error("Error de conexión:", error);
      }
    }

    // --- 2. FUNCIÓN MATEMÁTICA DE RESUMEN (NUEVO) ---
    function calcularEstadisticas(datos) {
        // 1. Total Histórico
        document.getElementById('stat-total').innerText = datos.length;

        // 2. Activos (Sumamos Vigentes y Vencidos, pues aun tienes la prenda)
        const activos = datos.filter(item => 
            item.estado === 'Vigente' || item.estado === 'Vencido'
        ).length;
        document.getElementById('stat-activos').innerText = activos;

        // 3. Desempeñados (Ya pagaron y se fueron)
        const desempenados = datos.filter(item => item.estado === 'Desempeñado').length;
        document.getElementById('stat-desempenados').innerText = desempenados;

        // 4. Perdidos (Rematados / Vendidos)
        const perdidos = datos.filter(item => 
            item.estado === 'Rematado' || item.estado === 'Vendido'
        ).length;
        document.getElementById('stat-perdidos').innerText = perdidos;
    }

    // --- 3. RENDERIZAR TABLA (Ya lo tenías) ---
    function renderizarTabla(listaDatos) {
      const tbody = document.getElementById('tabla-clientes-body');
      tbody.innerHTML = '';

      if (listaDatos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No se encontraron registros.</td></tr>';
        return;
      }

      listaDatos.forEach(item => {
        const tr = document.createElement('tr');
        
        let nombreCliente = `Cliente #${item.cliente_id}`;
        if (item.cliente) {
            nombreCliente = `${item.cliente.nombre} ${item.cliente.apellidos}`;
        }

        const montoFmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(item.monto_prestamo);
        const estadoClass = item.estado.toLowerCase();

        tr.innerHTML = `
          <td><strong>${nombreCliente}</strong></td> 
          <td>${item.id}</td>
          <td>${item.marca_modelo}</td>
          <td>${montoFmt}</td>
          <td>${item.fecha_empeno}</td>
          <td>${item.fecha_vencimiento}</td>
          <td><span class="status status-${estadoClass}">${item.estado}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- 4. FILTROS (Ya lo tenías, se mantiene igual) ---
    function filtrarDatos() {
      const texto = document.getElementById('filtro-texto').value.toLowerCase();
      const estado = document.getElementById('filtro-estado').value;
      const fechaInicio = document.getElementById('filtro-fecha-inicio').value;
      const fechaFin = document.getElementById('filtro-fecha-fin').value;

      const datosFiltrados = todosLosEmpenos.filter(item => {
        const nombreC = item.cliente ? `${item.cliente.nombre} ${item.cliente.apellidos}` : '';
        
        const coincideTexto = 
            item.marca_modelo.toLowerCase().includes(texto) ||
            item.id.toString().includes(texto) ||
            nombreC.toLowerCase().includes(texto);

        const coincideEstado = estado === "" || item.estado === estado;

        let coincideFecha = true;
        if (fechaInicio && fechaFin) {
          const fechaItem = new Date(item.fecha_empeno);
          const fInicio = new Date(fechaInicio);
          const fFin = new Date(fechaFin);
          coincideFecha = fechaItem >= fInicio && fechaItem <= fFin;
        }

        return coincideTexto && coincideEstado && coincideFecha;
      });

      renderizarTabla(datosFiltrados);
      
      // Opcional: ¿Quieres que los números de arriba cambien al filtrar?
      // Si sí, descomenta la siguiente línea:
      // calcularEstadisticas(datosFiltrados); 
    }

    // Listeners
    document.getElementById('filtro-texto').addEventListener('input', filtrarDatos);
    document.getElementById('filtro-estado').addEventListener('change', filtrarDatos);
    document.getElementById('filtro-fecha-inicio').addEventListener('change', filtrarDatos);
    document.getElementById('filtro-fecha-fin').addEventListener('change', filtrarDatos);

    // Inicializar
    document.addEventListener('DOMContentLoaded', cargarTabla);

    // Logout
    const btnLogout = document.querySelector('.logout-button');
    if(btnLogout){
        btnLogout.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token_auto_empeno');
            window.location.href = 'login.html';
        });
    }
  </script>
</body>
</html>