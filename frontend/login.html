<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acceso - Auto Empeño Luna</title>
  <link rel="stylesheet" href="login.css">
</head>
<body>

  <div class="split-container">

    <div class="brand-side">
      <h1>AUTO EMPEÑO <span>LUNA</span></h1>
      <div class="brand-logo">
        <img src="LOGOEMP.png" alt="Logo Auto Empeños Luna">
      </div>
      <p>Bienvenido al Panel de Control</p>
      <p class="slogan">
        ¡NO SOMOS UNA OPCIÓN,<br>
        <span>SOMOS TU SOLUCIÓN!</span>
      </p>
    </div>

    <div class="form-side">
      
      <form id="login-form" class="login-form">
        <h2>Iniciar Sesión</h2>
        
        <div class="input-group">
          <label for="usuario">Usuario</label>
          <input type="text" id="usuario" name="usuario" required placeholder="Ej: admin">
        </div>
  
        <div class="input-group">
          <label for="contrasena">Contraseña</label>
          <input type="password" id="contrasena" name="contrasena" required placeholder="••••••">
        </div>
  
        <button type="submit" class="login-btn">Ingresar</button>
        
        <p id="error-message" class="error-msg" style="display: none;"></p>

        <div class="switch-link">
          ¿Nuevo empleado? <a onclick="mostrarRegistro()">Regístralo aquí</a>
        </div>
      </form>


      <form id="register-form" class="login-form hidden">
        <h2>Registrar Empleado</h2>
        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
            Crea un usuario nuevo para el sistema.
        </p>

        <div class="input-group">
            <label>Nombre Completo</label>
            <input type="text" id="reg-nombre" required placeholder="Ej: Juan Pérez">
        </div>

        <div class="input-group">
            <label>Nuevo Usuario</label>
            <input type="text" id="reg-usuario" required placeholder="Ej: juanp">
        </div>

        <div class="input-group">
            <label>Nueva Contraseña</label>
            <input type="password" id="reg-pass" required placeholder="Crear contraseña">
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

        <div class="input-group master-pass-group">
            <label style="color: #d9534f; font-weight:bold;"> Contraseña de Admin</label>
            <input type="password" id="reg-admin-pass" required placeholder="Tu contraseña actual para confirmar">
            <small style="font-size: 0.7em; color: #888;">Necesaria para autorizar el registro.</small>
        </div>

        <button type="submit" class="login-btn" style="background: #2a5a8a;">Crear Usuario</button>
        
        <p id="reg-error-message" class="error-msg" style="display: none;"></p>

        <div class="switch-link">
          <a onclick="mostrarLogin()">← Volver al Login</a>
        </div>
      </form>

    </div>
  </div>

  <script>
    // --- LÓGICA DE INTERFAZ (SWAP) ---
    function mostrarRegistro() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('reg-error-message').style.display = 'none';
    }

    function mostrarLogin() {
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('error-message').style.display = 'none';
    }

    // --- 1. LÓGICA DE LOGIN (La que ya tenías) ---
    const loginForm = document.getElementById('login-form');
    const errorMessage = document.getElementById('error-message');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const usuario = document.getElementById('usuario').value;
      const contrasena = document.getElementById('contrasena').value;

      const datosParaEnviar = new URLSearchParams();
      datosParaEnviar.append('username', usuario);
      datosParaEnviar.append('password', contrasena);

      try {
        const response = await fetch('/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: datosParaEnviar
        });

        if (response.ok) {
          const result = await response.json();
          localStorage.setItem('token_auto_empeno', result.access_token);
          window.location.href = 'dash.html';
        } else {
          errorMessage.innerText = 'Usuario o contraseña incorrectos.';
          errorMessage.style.display = 'block';
        }
      } catch (error) {
        errorMessage.innerText = 'Error de conexión con el servidor.';
        errorMessage.style.display = 'block';
      }
    });

    // --- 2. LÓGICA DE REGISTRO (NUEVO) ---
    const registerForm = document.getElementById('register-form');
    const regErrorMessage = document.getElementById('reg-error-message');

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Recogemos datos
        const nombre = document.getElementById('reg-nombre').value;
        const usuario = document.getElementById('reg-usuario').value;
        const password = document.getElementById('reg-pass').value;
        const adminAuth = document.getElementById('reg-admin-pass').value;

        // Validar que no estén vacíos
        if(!nombre || !usuario || !password || !adminAuth) {
            regErrorMessage.innerText = "Todos los campos son obligatorios";
            regErrorMessage.style.display = "block";
            return;
        }

        const payload = {
            nuevo_usuario: {
                usuario: usuario,
                password: password,
                nombre_completo: nombre,
                rol: "empleado" // Por defecto creamos empleados
            },
            admin_password: adminAuth // Enviamos la contraseña del jefe para validar
        };

        try {
            // Nota: Este endpoint lo crearemos en el siguiente paso en Python
            const res = await fetch('/registrar-empleado-seguro', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("✅ ¡Usuario registrado exitosamente!\nAhora puedes iniciar sesión.");
                mostrarLogin();
                // Limpiar campos
                registerForm.reset();
            } else {
                const err = await res.json();
                regErrorMessage.innerText = err.detail || "Error al registrar";
                regErrorMessage.style.display = "block";
            }
        } catch (error) {
            regErrorMessage.innerText = "Error de conexión";
            regErrorMessage.style.display = "block";
        }
    });
  </script>
</body>
</html>